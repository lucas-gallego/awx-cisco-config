hostname {{ hostname }}
!
ip cef
no ipv6 cef
!
ip domain name {{ domain_name }}
multilink bundle-name authenticated
!
{# --- GESTION DU COMPTE ADMIN --- #}
username {{ admin_username }} privilege 15 secret {{ admin_password }}
!
ip ssh version 2
crypto key generate rsa modulus 2048
line vty 0 4 
 transport input SSH
!
{# --- DHCP POOLS (Noms et Options dynamiques) --- #}
!
ip dhcp pool {{ dhcp_pool_lan_name }}
 network {{ lan_data_network }} {{ lan_data_mask }}
 default-router {{ lan_data_gateway }} 
 domain-name {{ domain_name }}
 dns-server {{ dns_servers_lan }}
 option 167 ascii FALSE
 option 199 ascii defa-{{ site_code }}
 option 165 ascii 10.200.4.12:443
 option 166 ascii 10.200.4.12:1883
 lease 8
!
ip dhcp pool {{ dhcp_pool_voip_name }}
 network {{ lan_voip_network }} {{ lan_voip_mask }}
 dns-server {{ dns_servers_voip }}
 default-router {{ lan_voip_gateway }}
 option 150 ip 1.1.1.1
 lease 8
!
! ===== INTERFACES =====
interface Embedded-Service-Engine0/0
 no ip address
 shutdown
!
{# --- LOGIQUE DE BASCULE WAN (CUIVRE vs FIBRE) --- #}
{% if wan_type == 'fibre' %}
! --- MODE FIBRE ACTIVE (0/0/0) ---
interface GigabitEthernet0/0
 description WAN INTERNET (DESACTIVE - FIBRE UTILISEE)
 no ip address
 shutdown
!
interface GigabitEthernet0/0/0
 description WAN INTERNET (FIBRE)
 ip address {{ wan_ip }} {{ wan_mask }}
 ip nat outside
 ip virtual-reassembly in
 no shutdown
{% else %}
! --- MODE CUIVRE ACTIF (0/0) ---
interface GigabitEthernet0/0
 description WAN INTERNET (CUIVRE)
 ip address {{ wan_ip }} {{ wan_mask }}
 ip nat outside
 ip virtual-reassembly in
 duplex auto
 speed auto
 no shutdown
!
interface GigabitEthernet0/0/0
 description WAN INTERNET (DESACTIVE)
 no ip address
 shutdown
{% endif %}
!
{# --- LAN DATA --- #}
interface GigabitEthernet0/1
 description LAN DATA
 ip address {{ lan_data_gateway }} {{ lan_data_mask }}
 ip nat inside
 ip virtual-reassembly in
 duplex auto
 speed auto
 no shutdown
!
{# --- LAN VOIP --- #}
interface GigabitEthernet0/1.130
 description LAN VOIP
 encapsulation dot1Q 130
 ip address {{ lan_voip_gateway }} {{ lan_voip_mask }}
 ip nat inside
 ip virtual-reassembly in
 no shutdown
!
! ===== BGP VERS CORE =====
router bgp 64999
 bgp log-neighbor-changes
 neighbor {{ bgp_neighbor_ip }} remote-as 65500
 !
 address-family ipv4
  network {{ lan_data_network }} mask {{ lan_data_mask }}
  network {{ lan_voip_network }} mask {{ lan_voip_mask }}
  neighbor {{ bgp_neighbor_ip }} activate
 exit-address-family
!
! ===== NAT + ROUTE PAR DEFAUT =====
{% if wan_type == 'fibre' %}
ip nat inside source list 1 interface GigabitEthernet0/0/0 overload
{% else %}
ip nat inside source list 1 interface GigabitEthernet0/0 overload
{% endif %}
!
ip route 0.0.0.0 0.0.0.0 {{ wan_gateway }}
!
! ===== ACLs =====
access-list 1 permit {{ lan_data_network }} {{ lan_data_wildcard }}
access-list 1 permit {{ lan_voip_network }} {{ lan_voip_wildcard }}
!
access-list 100 permit ip {{ lan_data_network }} {{ lan_data_wildcard }} any
access-list 100 permit ip {{ lan_voip_network }} {{ lan_voip_wildcard }} any
!
line con 0
 logging synchronous
line aux 0
line vty 0 4
 login local
 transport input ssh
!
end
